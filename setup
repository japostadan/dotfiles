#!/bin/bash
set -euo pipefail

echo "[*] Running cross-platform setup..."

# Detect OS
OS="$(uname -s)"
case "$OS" in
    Linux*)     PLATFORM="linux";;
    Darwin*)    PLATFORM="macos";;
    *)          echo "[!] Unsupported platform: $OS" && exit 1;;
esac

echo "[*] Platform detected: $PLATFORM"

# Install packages
install_packages() {
    echo "[*] Installing packages: git, zsh, curl, kitty, tmux..."

    if [[ "$PLATFORM" == "macos" ]]; then
        if ! command -v brew >/dev/null; then
            echo "[*] Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
        brew install git zsh curl tmux kitty starship

    elif [[ "$PLATFORM" == "linux" ]]; then
        if command -v apt >/dev/null; then
            sudo apt update
            sudo apt install -y git zsh curl tmux kitty
            # Install starship manually for Linux apt systems
            curl -fsSL https://starship.rs/install.sh | bash -s -- -y
        elif command -v dnf >/dev/null; then
            sudo dnf install -y git zsh curl tmux kitty
            curl -fsSL https://starship.rs/install.sh | bash -s -- -y
        elif command -v pacman >/dev/null; then
            sudo pacman -Sy --noconfirm git zsh curl tmux kitty starship
        else
            echo "[!] Unsupported Linux package manager."
            exit 1
        fi
    fi
}

install_packages

# Install mise
if ! command -v mise >/dev/null 2>&1; then
    echo "[*] Installing mise..."
    curl https://mise.run | bash
    export PATH="$HOME/.local/share/mise/bin:$PATH"
else
    echo "[+] mise already installed: $(command -v mise)"
fi

# Add mise activation to .zshrc if missing
ZSHRC="$HOME/.zshrc"
if [ ! -f "$ZSHRC" ]; then
    touch "$ZSHRC"
fi
if ! grep -q 'mise activate' "$ZSHRC"; then
    echo 'eval "$(mise activate zsh)"' >> "$ZSHRC"
fi

# Add starship init to .zshrc if missing
if ! grep -q 'starship init zsh' "$ZSHRC"; then
    echo 'eval "$(starship init zsh)"' >> "$ZSHRC"
fi

# Install tools from .tool-versions
if [ -f "$HOME/.tool-versions" ]; then
    echo "[*] Installing mise tools..."
    mise install
fi

echo "[+] Setup complete."
